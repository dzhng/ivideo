var isWebKit="undefined"!==typeof navigator.userAgent.split("WebKit/")[1],isChrome=-1<navigator.userAgent.toLowerCase().indexOf("chrome"),isMozilla=0<=navigator.appVersion.indexOf("Gecko/")||0<=navigator.userAgent.indexOf("Gecko")&&!this.isWebKit&&"undefined"!==typeof navigator.appVersion;isWebKit&&console.log("WebKit browser detected");isChrome&&console.log("Chrome browser detected");isMozilla&&console.log("Mozilla browser detected");!isWebKit&&!isChrome&&!isMozilla&&console.error("Browser unsupported");var Clickable=function(a,b,c,e){this.x=a;this.y=b;this.width=c;this.height=e;this.highlighted=!1};Clickable.prototype.isHighlighted=function(a,b){return a>this.x&&b>this.y&&a<this.x+this.width&&b<this.y+this.height};var Connection=function(a,b,c){this.segment=a;this.option=b;this.position=c};var Controller=function(a){this.model=a;this.dragging=this.click=!1;this.y=this.x=0;this.pointerMoved=!1;this.mouseUpHandler=this.mouseUp.bind(this);window.addEventListener("mouseup",this.mouseUpHandler,!1);this.mouseDownHandler=this.mouseDown.bind(this);window.addEventListener("mousedown",this.mouseDownHandler,!1);this.mouseMoveHandler=this.mouseMove.bind(this);document.addEventListener("mousemove",this.mouseMoveHandler,!1);setInterval(this.frameRefresh.bind(this),33)};
Controller.prototype.mouseDown=function(a){if(2!=a.button)this.click=!0};Controller.prototype.mouseUp=function(a){if(2!=a.button&&(this.click=!1,this.model.stopDrag(),!0==this.dragging))this.dragging=!1};Controller.prototype.mouseMove=function(a){a.preventDefault();this.x=a.pageX;this.y=a.pageY;this.pointerMoved=!0};
Controller.prototype.frameRefresh=function(){if(this.pointerMoved)(this.x>=this.model.canvas.width||this.y>=this.model.canvas.height||0>=this.x||0>=this.y)&&this.model.stopDrag(),this.click?this.dragging=!0:this.model.mouseMove(),this.pointerMoved=!1};Function.prototype.bind=function(a){var b=this;return function(){return b.apply(a,arguments)}};var Model=function(){this.position=-1;this.canvas=document.getElementById("controlOverlay");this.canvas.width=window.innerWidth;this.canvas.height=window.innerHeight;var a=this.canvas.width,b=this.canvas.height;console.log("Width: %d, Height: %d",a,b);this.radius=a/22;this.lineWidth=this.radius/4;this.fsize=this.radius/2.5;this.x=a/2;this.y=b-2*this.radius;this.context=this.canvas.getContext("2d");this.context.font="Bold "+this.fsize+"pt Arial";this.context.textBaseline="top";this.player=new Player(this,
a,b);this.controller=new Controller(this);this.options=Array(6);this.playButton=new Playbutton(a/2-3*this.radius/2,b/2-3*this.radius/2,3*this.radius,3*this.radius);this.optionsVisible=!1;this.replay=this.controlsVisible=!0;this.animationId=setInterval(this.draw.bind(this),33);this.timedEventCount=0};
Model.prototype.mouseMove=function(){if(!0==this.controlsVisible)this.playButton.highlighted=this.playButton.isHighlighted(this.controller.x,this.controller.y)?!0:!1;else if(!0==this.optionsVisible){this.position=-1;for(var a=0;a<this.options.length;a++)if(void 0!=this.options[a]){if(this.options[a].isHighlighted(this.controller.x,this.controller.y)){this.options[a].highlighted=!0;this.position=a;break}this.options[a].highlighted=!1}}};
Model.prototype.stopDrag=function(){if(!0==this.controlsVisible)this.replay=this.playButton.highlighted=!0,this.player.segment.removeVideo(),this.player.reset(),this.controlsVisible=!1,this.player.playVideo();else if(!0==this.optionsVisible){if(-1!=this.position)this.optionsVisible=!1,this.player.chooseOption(this.position)}else this.player.timerEventCanTrigger&&this.player.setSegment(this.player.timerEventSegment)};Model.prototype.videoComplete=function(){this.controlsVisible=this.replay=!0};
Model.prototype.showOptions=function(a){var b=this.x,c=this.y,e=1.2*this.radius,d,f=1.2*this.fsize;d=!1;this.options=Array(6);for(var g=Array(6),h=0;6>h;h++)g[h]=a.getConnectionByPosition(h);if(null!=g[0])a=g[0].option,mes=this.context.measureText(a),d=mes.width,this.options[0]=new Option(a,b-0.7*e-d,c-0.7*e-f,d,f),d=!0;if(null!=g[1])a=g[1].option,mes=this.context.measureText(a),d=mes.width,this.options[1]=new Option(a,b-e-d,c-f/2,d,f),d=!0;if(null!=g[2])a=g[2].option,mes=this.context.measureText(a),
d=mes.width,this.options[2]=new Option(a,b-0.7*e-d,c+0.7*e,d,f),d=!0;if(null!=g[3])a=g[3].option,mes=this.context.measureText(a),d=mes.width,this.options[3]=new Option(a,b+0.7*e,c+0.7*e,d,f),d=!0;if(null!=g[4])a=g[4].option,mes=this.context.measureText(a),d=mes.width,this.options[4]=new Option(a,b+e,c-f/2,d,f),d=!0;if(null!=g[5])a=g[5].option,mes=this.context.measureText(a),d=mes.width,this.options[5]=new Option(a,b+0.7*e,c-0.7*e-f,d,f),d=!0;return!d?this.optionsVisible=!1:this.optionsVisible=!0};
Model.prototype.draw=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);if(!0==this.optionsVisible){this.context.save();this.context.lineWidth=this.lineWidth;this.context.strokeStyle="rgb(0,140,158)";this.context.beginPath();this.context.arc(this.x,this.y,this.radius,0,2*Math.PI,!0);this.context.closePath();this.context.stroke();var a=this.x-2*this.lineWidth,b=this.y-1.8*this.lineWidth,c=4*this.lineWidth,e=3*this.lineWidth,d=this.lineWidth/2;this.context.fillStyle="rgb(0,180,204)";
this.context.strokeStyle="rgb(250,105,0)";this.context.lineWidth=this.lineWidth/4;this.context.beginPath();this.context.moveTo(a+d,b);this.context.lineTo(a+c-d,b);this.context.quadraticCurveTo(a+c,b,a+c,b+d);this.context.lineTo(a+c,b+e-d);this.context.quadraticCurveTo(a+c,b+e,a+c-d,b+e);this.context.lineTo(a+d+2*this.lineWidth,b+e);this.context.lineTo(a+d+this.lineWidth,b+e+this.lineWidth);this.context.lineTo(a+d+this.lineWidth,b+e);this.context.lineTo(a+d,b+e);this.context.quadraticCurveTo(a,b+e,
a,b+e-d);this.context.lineTo(a,b+d);this.context.quadraticCurveTo(a,b,a+d,b);this.context.closePath();this.context.fill();this.context.stroke();this.context.lineWidth=this.lineWidth/10;this.context.strokeStyle="rgb(0,95,107)";this.context.beginPath();this.context.arc(this.x,this.y,this.radius+this.lineWidth/2,0,2*Math.PI,!0);this.context.closePath();this.context.stroke();this.context.beginPath();this.context.arc(this.x,this.y,this.radius-this.lineWidth/2,0,2*Math.PI,!0);this.context.closePath();this.context.stroke();
this.context.restore();this.context.save();this.context.translate(this.x,this.y);a=Math.atan((this.y-this.controller.y)/(this.controller.x-this.x));0>this.controller.x-this.x&&(a-=Math.PI);this.context.rotate(-1*a);var f=this.context.createLinearGradient(this.radius,0,-1*this.radius,0);f.addColorStop(0,"rgb(0,223,252)");f.addColorStop(0.8,"rgba(0,140,158,0)");this.context.strokeStyle=f;this.context.lineWidth=this.lineWidth;this.context.beginPath();this.context.arc(0,0,this.radius,0,2*Math.PI,!0);
this.context.closePath();this.context.stroke();this.context.lineWidth=this.lineWidth/20;this.context.strokeStyle="rgb(0,95,107)";this.context.fillStyle=f;this.context.beginPath();this.context.moveTo(this.radius-this.lineWidth/20-this.lineWidth/2,0);this.context.lineTo(this.radius-this.lineWidth/20-this.lineWidth/2-this.fsize/2,this.fsize/3);this.context.lineTo(this.radius-this.lineWidth/20-this.lineWidth/2-this.fsize/2,-1*this.fsize/3);this.context.closePath();this.context.fill();this.context.stroke();
f=this.context.createLinearGradient(this.radius,0,-1*this.radius,0);f.addColorStop(0.2,"rgba(0,0,0,0.4)");f.addColorStop(0.8,"rgba(255,255,255,0.3)");this.context.lineWidth=this.lineWidth/2;this.context.strokeStyle=f;this.context.beginPath();this.context.arc(0,0,this.radius-this.lineWidth/4,0,2*Math.PI,!0);this.context.closePath();this.context.stroke();f=this.context.createLinearGradient(this.radius,0,-1*this.radius,0);f.addColorStop(0,"rgba(255,255,255,0.3)");f.addColorStop(0.8,"rgba(0,0,0,0.3)");
this.context.lineWidth=this.lineWidth/20;this.context.strokeStyle=f;this.context.beginPath();this.context.arc(0,0,this.radius,0,2*Math.PI,!0);this.context.closePath();this.context.stroke();this.context.rotate(a);f=this.context.createLinearGradient(this.radius,0,-1*this.radius,0);f.addColorStop(0.2,"rgba(255,255,255,0.4)");f.addColorStop(0.8,"rgba(0,0,0,0.4)");a=-2*this.lineWidth;b=-1.8*this.lineWidth;this.context.fillStyle=f;this.context.beginPath();this.context.moveTo(a+d,b);this.context.lineTo(a+
c-d,b);this.context.quadraticCurveTo(a+c,b,a+c,b+d);this.context.lineTo(a+c,b+e-d);this.context.quadraticCurveTo(a+c,b+e,a+c-d,b+e);this.context.lineTo(a+d+2*this.lineWidth,b+e);this.context.lineTo(a+d+this.lineWidth,b+e+this.lineWidth);this.context.lineTo(a+d+this.lineWidth,b+e);this.context.lineTo(a+d,b+e);this.context.quadraticCurveTo(a,b+e,a,b+e-d);this.context.lineTo(a,b+d);this.context.quadraticCurveTo(a,b,a+d,b);this.context.closePath();this.context.fill();this.context.restore();for(c=0;c<
this.options.length;c++)void 0!=this.options[c]&&(this.context.save(),this.options[c].draw(this.context),this.context.restore())}if(!0==this.controlsVisible)this.context.fillStyle="rgba(0,0,0,0.5)",this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.playButton.draw(this.context);if(this.player.timerEventCanTrigger)this.context.save(),this.context.font="Bold "+2*this.fsize+"pt Arial",a=this.canvas.width-this.radius,b=this.canvas.height-1.5*this.radius,this.context.fillStyle="rgb(52,56,56)",
this.context.fillText("!",a+1,b+1),this.context.fillStyle="rgba(0,223,252,"+Math.abs(Math.sin(this.timedEventCount/5))+")",this.context.fillText("!",a,b),this.context.restore(),this.timedEventCount++};var Option=function(a,b,c,e,d){this.text=a;this.x=b;this.y=c;this.width=e;this.height=d;this.highlighted=!1};Option.prototype=new Clickable;Option.prototype.draw=function(a){!0==this.highlighted?(a.fillStyle="rgb(200,50,0)",a.fillText(this.text,this.x+1,this.y+1),a.fillStyle="rgb(250, 105, 0)"):(a.fillStyle="rgb(52,56,56)",a.fillText(this.text,this.x+1,this.y+1),a.fillStyle="rgb(250,250,250)");a.fillText(this.text,this.x,this.y)};var Playbutton=function(a,b,c,e){this.x=a;this.y=b;this.width=c;this.height=e;this.highlighted=!1};Playbutton.prototype=new Clickable;Playbutton.prototype.draw=function(a){a.beginPath();a.moveTo(this.x,this.y);a.lineTo(this.x+this.width,this.y+this.height/2);a.lineTo(this.x,this.y+this.height);a.closePath();a.fillStyle=!0==this.highlighted?"rgb(250,105,0)":"rgb(0,180,204)";a.fill()};var Player=function(a,b,c){this.width=b;this.height=c;this.model=a;this.reset();this.timerEventCanTrigger=!1;this.timerEventSegment=null;this.timerId=setInterval(this.timerTick.bind(this),100)};Player.prototype.reset=function(){this.segment=S1;this.segment.loadVideo(this);this.segment.setVisible();this.preloadVideo()};
Player.prototype.preloadVideo=function(){console.log("video has %d connections",this.segment.connections.length);for(var a=0;a<this.segment.connections.length;a++){var b=this.segment.connections[a].segment;b.loadVideo(this)}console.log("video has %d timed events",this.segment.timedEvents.length);for(a=0;a<this.segment.timedEvents.length;a++)b=this.segment.timedEvents[a].segment,b.loadVideo(this)};Player.prototype.playVideo=function(){this.segment.setVisible();this.segment.play()};
Player.prototype.skipToEnd=function(){};Player.prototype.pauseVideo=function(){this.segment.pause()};Player.prototype.isPaused=function(){return this.segment.video.paused};Player.prototype.setSegment=function(a){this.segment.removeVideo();this.segment=a;this.preloadVideo();this.playVideo()};Player.prototype.chooseOption=function(a){console.log("option %d choosen",a);this.setSegment(this.segment.chooseConnection(a).segment)};
Player.prototype.timerTick=function(){var a=this.segment;if(null!=a.video)if(a.video.currentTime>=a.video.duration)this.videoEnded();else{for(var b=0;b<a.timedEvents.length;b++){var c=a.timedEvents[b];if(a.video.currentTime>c.startTime&&a.video.currentTime<c.endTime){this.timerEventCanTrigger=!0;this.timerEventSegment=c.segment;return}}this.timerEventCanTrigger=!1;this.timerEventSegment=null}};
Player.prototype.videoEnded=function(){-1!=this.segment.defaultPos?(console.log("direct video detected, not showing options"),this.chooseOption(this.segment.defaultPos)):this.model.showOptions(this.segment)||(console.log("no more options, end of interactive video"),this.model.videoComplete())};var Segment=function(a){this.url=a;this.defaultPos=-1;this.connections=[];this.timedEvents=[];this.player=this.video=null};Segment.prototype.setVisible=function(){this.video.style.visibility="visible"};Segment.prototype.play=function(){this.video.play()};Segment.prototype.pause=function(){this.video.pause()};Segment.prototype.getConnectionByPosition=function(a){for(var b=0;b<this.connections.length;b++)if(this.connections[b].position===a)return this.connections[b];return null};
Segment.prototype.chooseConnection=function(a){for(var b,c=0;c<this.connections.length;c++)this.connections[c].position===a?b=c:this.connections[c].segment.removeVideo();return this.connections[b]};Segment.prototype.insertDirect=function(a){this.defaultPos++;this.connections.push(new Connection(a,"",this.defaultPos))};Segment.prototype.insertConnection=function(a,b,c){this.connections.push(new Connection(a,b,c))};
Segment.prototype.insertTimedEvent=function(a,b,c){this.timedEvents.push(new TimedEvent(a,b,c))};Segment.prototype.loadVideo=function(a){this.player=a;if(null==this.video)a=document.createElement("video"),a.controls=!1,a.volume=1,a.preload="auto",a.style.visibility="hidden",a.style.position="absolute",a.width=this.player.width,a.height=this.player.height,document.body.appendChild(a),this.video=a;this.video.src=setVideoUrl(this.url);this.video.load()};
Segment.prototype.removeVideo=function(){if(null!=this.video)document.body.removeChild(this.video),this.video=null};Segment.prototype.videoEnded=function(){this.player.videoEnded()};Segment.prototype.videoLoaded=function(){this.paused?(console.log("video loaded, paused"),this.currentTime=0.1):(console.log("video loaded, playing"),this.currentTime=0.1,this.play(),setTimeout(this.play.bind(this),33))};var setVideoUrl=function(a){return""==a||null==a?null:isMozilla?"../videos/"+a+".ogv":"../videos/"+a+".mp4"};var TimedEvent=function(a,b,c){this.segment=a;this.startTime=b;this.endTime=c};
